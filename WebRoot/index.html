<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="GBK">
    <title>主页</title>
    <link href="public/stylesheet/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="public/stylesheet/ctrl-btn.css"/>
    <link rel="stylesheet" href="public/stylesheet/index.css"/>

</head>
<body>
<section id="msgBar"></section>
<!--遮罩层-->
<section id="maskLayer"></section>
<header>
    <section id="logo">TaMusic</section>
    <section id="user">
        <ul>
            <li>
                <svg>
                    <use xlink:href="public/font/icon.svg#iconfont-person2"/>
                </svg>
                <span>馒头上线了</span>
            </li>
            <li>
                <svg>
                    <use xlink:href="public/font/icon.svg#iconfont-history"/>
                </svg>
                <span>172342</span>
            </li>
            <li>
                <svg>
                    <use xlink:href="public/font/icon.svg#iconfont-like"/>
                </svg>
                <span>725</span>
            </li>
            <li>
                <svg>
                    <use xlink:href="public/font/icon.svg#iconfont-delete"/>
                </svg>
                <span>348</span>
            </li>
        </ul>
    </section>
</header>
<!--主页、显示歌词和歌曲信息-->
<section id="main">
    <article>
        <div class="lrc">
            <ul></ul>
        </div>
        <div id="info" class="info-fix">
            <img src="public/image/cover.jpg" alt=""/>

            <div id="info-img">
                <i class="fa fa-play"></i>

                <p>点击继续播放</p>
            </div>
            <i id="fixed" class="fa fa-anchor"></i>

            <p id="name">Wish I Stayed</p>

            <p id="singer">Ellie Goulding</p>
            <i id="like" class="fa fa-heart-o"></i>
            <i id="dislike" class="fa fa-trash-o"></i>
        </div>
        <div class="panel-btn">
            <i class="fa fa-chevron-left"></i>
        </div>
    </article>
</section>
<!--频道列表-->
<section id="panel">
    <article>
        <ul>
            <li id="srpd"><span class="gif"></span>
                <i class="fa fa-user"></i>

                <p>私人频道</p>
            </li>
            <li id="hxpd"><span class="gif"></span>
                <i class="fa fa-heart"></i>

                <p>红心频道</p>
            </li>
            <li id="rmpd"><span class="gif"></span>
                <i class="fa fa-area-chart"></i>

                <p>热门频道</p>
            </li>
            <li id="sbtt" class="panel-active"><span class="gif" style="display: inline-block"></span>
                <i class="fa fa-coffee"></i>

                <p>随便听听</p>
            </li>
            <a href="upload.html" target="_blank">
                <li>
                    <i class="fa fa-cloud-upload"></i>

                    <p>上传歌曲</p>
                </li>
            </a>
        </ul>
        <div style="clear: both;"></div>
    </article>
</section>
<!--我上传的文件-->
<section id="myfile">
    <ul></ul>
</section>
<footer>
    <!--控制器-->
    <section id="ctrl">
        <div class="btn" style="width: 35px;top: 44px;">
            <input type="checkbox" id="toggle-menu"/>
            <label for="toggle-menu">
                <span class="menu-icon"></span>
            </label>
        </div>
        <div class="btn">
            <button onclick="play('song/previous')" class="cbutton cbutton--effect-ivana">
                <i class="cbutton__icon fa fa-fw fa-step-backward"></i>
            </button>
        </div>
        <div id="play" class="btn btn--play-pause playing">
            <svg viewbox="0 0 40 40" class="btn__icon">
                <circle cx="20" cy="20" r="19" transform="rotate(-90 20 20)"
                        class="icon__shape icon__shape--circle icon__shape--orange"></circle>
                <circle cx="20" cy="20" r="19" transform="rotate(-90 20 20)"
                        class="icon__shape icon__shape--circle icon__shape--white"></circle>
                <polygon points="16,14 16,26 27.5,19.8" class="icon__shape icon__shape--triangle"></polygon>
                <line x1="24" y1="14" x2="24" y2="26" class="icon__shape icon__shape--line"></line>
            </svg>
            <div class="btn__shadow"></div>
        </div>
        <div class="btn">
            <button onclick="play()" class="cbutton cbutton--effect-ivana">
                <i class="cbutton__icon fa fa-fw fa-step-forward"></i>
            </button>
        </div>
        <div class="btn btn--volume btn--volume-2">
            <svg viewbox="0 0 174 40" class="btn__icon" style="height: 33px;">
                <path d="M2.8,20.4c0-17.4,19-19,19-19v38C21.8,39.4,2.8,37.8,2.8,20.4z" class="icon__shape"></path>
                <line x1="26" y1="7.9" x2="1" y2="32.9"
                      class="icon__shape icon__shape--line-mute icon__shape--orange"></line>
                <line x1="26" y1="7.9" x2="1" y2="32.9"
                      class="icon__shape icon__shape--line-mute icon__shape--white"></line>
                <line x1="37.8" y1="20" x2="162.8" y2="20"
                      class="icon__shape icon__shape--line-controls icon__shape--translucide"></line>
                <line x1="37.8" y1="20" x2="162.8" y2="20"
                      class="icon__shape icon__shape--line-controls icon__shape--white"></line>
                <circle cx="24.8" cy="20" r="19" transform="rotate(45 25 20)"
                        class="icon__shape icon__shape--circle-big icon__shape--translucide"></circle>
                <circle cx="24.8" cy="20" r="13" transform="rotate(-45 25 20)"
                        class="icon__shape icon__shape--circle-medium icon__shape--translucide"></circle>
                <circle cx="24.8" cy="20" r="7" transform="rotate(-45 25 20)"
                        class="icon__shape icon__shape--circle-small icon__shape--translucide"></circle>
                <circle cx="37.8" cy="20" r="0" class="icon__shape icon__shape--circle-controls"></circle>
                <circle cx="37.8" cy="20" r="1" class="icon__shape icon__shape--circle-placeholder"></circle>
            </svg>
            <div class="btn__shadow"></div>
        </div>
    </section>
    <section id="bar">
        <div class="progress"></div>
        <span class="progress-text"></span>
    </section>
    <section id="setting"></section>
</footer>
<input type="file" id="lrcfile" accept=".lrc,.LRC" style="display: none;"/>
<script src="public/javascript/jquery.min.js"></script>
<script src="public/javascript/velocity.min.js"></script>
<script src='public/javascript/hammer.js'></script>
<script src='public/javascript/TweenMax.min.js'></script>
<script src="public/javascript/ctrl-btn.js"></script>
<script>
    var audio = document.createElement('audio');//设置全局audio
    var islrc = false;//判断lrc文件是否存在
    var lrcdata = [];//歌词文件内容
    var panel = 'sbtt';//频道类型
    $(document).ready(function () {
        play();
    });
    //刷新页面后、点击下一曲 直接获取歌曲
    function play(str) {
        var url = arguments[0] ? arguments[0] : 'song/play/' + panel;
        console.log(url);
        $.ajax({
            type: 'get',
            url: url,
            dataType: 'json',
            success: function (data) {
                palysong(data)
            }
        });
    }
    //播放歌曲
    function palysong(data) {

        if (data.status) {
            if (data.song.lrc.length > 10) {//判断src是否存在
                var lrc = Parser(data.song.lrc);//解析lrc
                initLrc(lrc);//将lrc填充到网页
                islrc = true;//设置全局变量
                lrcdata = lrc;
            } else {
                $('.lrc ul').html('<li>暂无歌词,或者你可以<a href="javascript:lrcupload()">点击上传</a></li>');
                islrc = false;
                lrcdata = [];
            }
            loadAudio(data.song);//创建音频文件，填充到页面
            //填充歌曲名和歌手 封面、红心状态
            $('#name').text(data.song.name);
            $('#singer').text(data.song.singer);
            $('#info').find('img').attr('src', data.song.img);
            if (data.islike) {
                $('#like').removeClass('fa-heart-o').addClass('fa-heart').css('color', 'red');
            } else {
                $('#like').removeClass('fa-heart').addClass('fa-heart-o').css('color', 'black');
            }
            var lastI = -1, lastTime = 0;
            audio.ontimeupdate = function () {
                //设置进度条
                $('.progress').css('width', (this.currentTime / this.duration) * 100 + '%');
                //设置结束时间
                $('.progress-text').text('-' + parseInt((this.duration - this.currentTime) / 60) + ':' + parseInt((this.duration - this.currentTime) % 60));
                //若歌词存在
                if (islrc) {
                    for (var i = 0; i < lrcdata.length; i++) {
//                        if (this.currentTime * 1000 < lrc[i].time + 1000) {
                        if (this.currentTime * 1000 < lrcdata[i].time) {
                            break;
                        }
                        if (lastI < i) {
                            //歌词变色
                            $('.lrc ul li').removeClass('current');
                            $('#li_' + i).addClass('current');
                            //滚
                            $('.lrc ul').animate({top: 350 - 35 * i + 'px'}, 0);
                            lastI = i;
                        }
                    }
                    if (lastTime > this.currentTime) {
                        lastI = 0;
                    }
                    lastTime = this.currentTime;
                }
            };


        }
    }
    //歌曲播放完毕
    audio.addEventListener('ended', function () {
        //保存播放记录
        $.ajax({
            type: 'get',
            url: 'song/history/' + $(audio).data('songid'),
            dataType: 'json',
            success: function (data) {
                console.log(data);
            }
        });
        play();
    }, false);
    //设置暂停播放按钮
    $('#play').on('click', function () {
        if ($(this).hasClass("playing")) {
            audio.pause();
            $(this).removeClass("playing");
        } else {
            audio.play();
            $(this).addClass("playing");
        }
    });

    //设置播放位置
    $('#bar').on('mousedown', function (e) {
        if (3 == e.which) {
            return false;
        }
        $(this).on('mousemove', function (e2) {
            $('.progress').css('width', e2.offsetX + 'px');
            audio.currentTime = (e2.offsetX / $(this).width()) * audio.duration;
        });

        $(this).on('mouseup', function (e3) {
            $(this).unbind('mousemove');
            $('.progress').css('width', e3.offsetX + 'px');
            audio.currentTime = (e3.offsetX / $(this).width()) * audio.duration;
        })
    });

    function loadAudio(song) {

        audio.setAttribute('src', song.src);
        $(audio).data('songid', song.songid);
        audio.play();
        $('#process').append(audio);

    }
    function initLrc(lrc) {
        $('.lrc ul').empty();
        for (var i = 0; i < lrc.length; i++) {
            $('.lrc ul').append('<li id="li_' + i + '">' + lrc[i].txt + '</li>');
        }
        $('#li_0').addClass('current');
    }
    function Parser(lrc) {
        var timeExp = /\[(\d{2,})\:(\d{2})(?:\.(\d{2,3}))?\]/g;

        lrc = trim(lrc);
        this.lrc = lrc;//lrc 歌词
        this.lines = [];//解析结果
        var line, time, lines = lrc.split(/\n/)
                , _last;

        timeExp.lastIndex = 0;
        for (var i = 0, l = lines.length; i < l; i++) {
            while (time = timeExp.exec(lines[i])) {
                _last = timeExp.lastIndex;
                line = trim(lines[i].replace(timeExp, ''));
                timeExp.lastIndex = _last;
                if (time[3].length == 2)
                    this.lines.push({
                        time: time[1] * 60 * 1000 + time[2] * 1000 + (time[3] || 0) * 10
                        , originLineNum: i
                        , txt: line
                    });
                else this.lines.push({
                    time: time[1] * 60 * 1000 + time[2] * 1000 + (time[3] || 0) * 1
                    , originLineNum: i
                    , txt: line
                });
            }
        }
        this.lines.sort(function (a, b) {
            return a.time - b.time;
        });


        return this.lines;
    }
    function trim(lrc) {
        return lrc.replace(/(^\s*|\s*$)/m, '')
    }
    $('.cbutton').on('click', function () {
        $(this).css('border-color', '#3c8ddc').css('color', '#3c8ddc').addClass('cbutton--click');
        setTimeout(function () {
            $('.cbutton').css('border-color', '#fff').css('color', '#fff').removeClass('cbutton--click');
        }, 1100)
    });

    //打开频道页
    var panel_active = 0;
    $('.panel-btn').on('click', function () {
        if (panel_active == 0) {
            $('#panel').velocity("stop").velocity({left: '0'}, 500);
            $('#maskLayer').css('display','block');
            panel_active = 1;
        } else {
            $('#maskLayer').css('display','none');
            $('#panel').velocity("stop").velocity({left: '100%', 'diaplay': 'none'}, 500);
            panel_active = 0;
        }
    });

    $('#toggle-menu').on('click', function () {
        if (this.checked) {
            $('#myfile').velocity({left: '0'}, "easeOutQuad");
            getMyfile();
        } else {
            $('#myfile').velocity({left: '-350px'}, "easeInSine");
        }
    });
    //获取我上传的文件
    function getMyfile() {
        $.ajax({
            type: 'get',
            url: 'song/myfile',
            dataType: 'json',
            success: function (data) {
                if (data.status) {
                    var html = '';
                    for (var i = 0; i < data.songs.length; i++) {
                        html += '<li class="song" title="' + data.songs[i].name + '" data-id="' + data.songs[i].songid + '">' + data.songs[i].name + '</li>';
                    }
                    $('#myfile ul').html(html);
                } else {
                    $('#myfile ul').html(data.msg);
                }

            }
        })
    }
    //根据id播放歌曲
    $(document).on('click', '.song', function () {
        play('song/' + $(this).data('id'));
    });

    //上传歌词文件
    function lrcupload() {
        $lrc = $('#lrcfile');
        $lrc.click();
        $lrc.change(function () {
            // FormData 对象
            var form = new FormData();
            form.append("file", $lrc[0].files[0]);// 文件对象  卧槽这
            // XMLHttpRequest对象
            var xhr = new XMLHttpRequest();
            xhr.enctype = "multipart/form-data";
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var data = eval('(' + xhr.responseText + ')');
                    if (data.status) {
                        var lrc = Parser(data.lrc);
                        initLrc(lrc);//将lrc填充到网页
                        islrc = true;
                        lrcdata = lrc;
                    } else {
                        islrc = false;
                        lrcdata = [];
                    }

                }
            };
            xhr.open("post", 'file/upload/' + $(audio).data('songid') + '/lrc', true);
            xhr.send(form);
        });

    }

    //频道点击
    $('#panel').find('li').on('click', function () {
        $(this).parent().find('span').css('display', 'none');
        $(this).siblings().removeClass('panel-active');
        $(this).addClass('panel-active');
        $(this).find('span').css('display', 'inline-block');
    });
    $('#srpd').on('click', function () {
        panel = 'srpd';
        play();
    });
    $('#hxpd').on('click', function () {
        panel = 'hxpd';
        play();
    });
    $('#sbtt').on('click', function () {
        panel = 'sbtt';
        play();
    });
    $('#rmpd').on('click', function () {
        panel = 'rmpd';
        play();
    });

    //固定封面信息
    $('#fixed').on('click', function () {
        var $info = $('#info');
        if ($info.hasClass('info-fix')) {
            $info.removeClass('info-fix');
        } else {
            $info.addClass('info-fix');
        }
    });
    //点击封面暂停
    $('#info-img').on('click', function () {
        $('#play').click();
        playPauseUIButton.toggle();

    });
    //点击红心
    $('#like').on('click', function () {
        $.ajax({
            type: 'get',
            url: 'song/like/' + $(audio).data('songid'),
            dataType: 'json',
            success: function (data) {
                console.log(data);
                if (data.status) {
                    if (data.count == 1) {
                        $('#like').removeClass('fa-heart-o').addClass('fa-heart').css('color', 'red');
                    } else {
                        $('#like').removeClass('fa-heart').addClass('fa-heart-o').css('color', 'black');
                    }
                } else {
                    alert(data.msg);
                }

            }
        });


    });
    //添加不喜欢
    $('#dislike').on('click', function () {
        $.ajax({
            type: 'get',
            url: 'song/dislike/' + $(audio).data('songid'),
            dataType: 'json',
            success: function (data) {
                if (data.status) {
                    play();
                } else {
                    alert(data.msg);
                }

            }
        });
    })
</script>
</body>
</html>